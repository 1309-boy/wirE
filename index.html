<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wire Defense Game</title>
<style>
  :root{
    --wall: #555;   /* 벽 색 */
    --arena:#222;   /* 경기장 내부 */
    --page: #101010;
  }
  html,body{
    margin:0; height:100%;
    background:var(--page); color:#fff;
    font-family:system-ui, sans-serif;
    user-select:none; -webkit-user-select:none; overflow:hidden;
  }

  #app{
    height:100dvh;
    padding-bottom:env(safe-area-inset-bottom,0);
    display:flex; flex-direction:column;
  }

  #playArea{
    position:relative; flex:1;
    display:flex; align-items:center; justify-content:center;
    background:#181818;
  }

  #gameCanvas{
    display:block;
    background:var(--arena);
  }

  #scoreDisplay{
    position:absolute; left:12px; top:12px; z-index:2;
    font-weight:700; font-size:20px; text-shadow:0 2px 4px rgba(0,0,0,.4);
  }

  #joystickContainer{
    height:260px;
    display:grid;
    grid-template-columns:90px 90px 90px;
    grid-template-rows:90px 90px 90px;
    align-self:center;
    margin-bottom:calc(env(safe-area-inset-bottom,0) + 8px);
    touch-action:none;
  }
  .joyBtn,.joyEmpty{ width:90px; height:90px; }
  .joyBtn{
    border-radius:18px; background:#333; border:1px solid #666; color:#eee;
    display:flex; justify-content:center; align-items:center; font-size:30px;
  }
  .joyBtn:active{ background:#555; }
  .joyEmpty{ background:transparent; }
</style>
</head>
<body>
  <div id="app">
    <div id="playArea">
      <canvas id="gameCanvas" width="800" height="600"></canvas>
      <div id="scoreDisplay">점수: 0</div>
    </div>

    <div id="joystickContainer">
      <div class="joyEmpty"></div>            <div id="btnUp"    class="joyBtn">▲</div> <div class="joyEmpty"></div>
      <div id="btnLeft" class="joyBtn">◀</div><div class="joyEmpty"></div>              <div id="btnRight" class="joyBtn">▶</div>
      <div class="joyEmpty"></div>            <div id="btnDown"  class="joyBtn">▼</div> <div class="joyEmpty"></div>
    </div>
  </div>

<script>
(function(){
  const canvas=document.getElementById('gameCanvas');
  const ctx=canvas.getContext('2d');
  const scoreEl=document.getElementById('scoreDisplay');
  const playArea=document.getElementById('playArea');
  const joy=document.getElementById('joystickContainer');
  const isTouch=('ontouchstart' in window)||(navigator.maxTouchPoints>0);
  if(!isTouch) joy.style.display='none';

  const state={
    player:{x:0,y:0,width:24,height:36,speed:2.2,dir:{up:false,down:false,left:false,right:false}},
    balls:[],
    score:0,
    wirePoints:[],
    wireLine:null,
    lastSpawn:0,spawnInterval:1500,bounceDecay:0.9
  };

  const WALL_THICK=14, HALF_WALL=WALL_THICK/2;

  function resizeCanvas(){
    const cw=playArea.clientWidth,ch=playArea.clientHeight,aspect=4/3;
    let w=cw,h=cw/aspect; if(h>ch){h=ch;w=h*aspect;}
    canvas.width=w; canvas.height=h;
    state.player.x=canvas.width/2; state.player.y=canvas.height/2;
  }
  window.addEventListener('resize',resizeCanvas); resizeCanvas();

  const redSprite=['00100','01110','11111','01110','10101','10101','10101'];
  function drawPlayer(x,y){
    const s=6; const sx=x-(redSprite[0].length*s)/2, sy=y-(redSprite.length*s)/2;
    ctx.fillStyle='#f44';
    for(let r=0;r<redSprite.length;r++)for(let c=0;c<redSprite[r].length;c++)
      if(redSprite[r][c]==='1') ctx.fillRect(sx+c*s,sy+r*s,s,s);
  }

  // 입력 처리
  document.addEventListener('keydown',e=>{
    if(e.key==='w')state.player.dir.up=true;
    if(e.key==='s')state.player.dir.down=true;
    if(e.key==='a')state.player.dir.left=true;
    if(e.key==='d')state.player.dir.right=true;
  });
  document.addEventListener('keyup',e=>{
    if(e.key==='w')state.player.dir.up=false;
    if(e.key==='s')state.player.dir.down=false;
    if(e.key==='a')state.player.dir.left=false;
    if(e.key==='d')state.player.dir.right=false;
  });

  if(isTouch){
    const $=id=>document.getElementById(id);
    const map={up:$('btnUp'),down:$('btnDown'),left:$('btnLeft'),right:$('btnRight')};
    for(const k in map){
      map[k].addEventListener('touchstart',ev=>{ev.preventDefault();state.player.dir[k]=true;});
      map[k].addEventListener('touchend',ev=>{ev.preventDefault();state.player.dir[k]=false;});
    }
  }

  // --- 와이어 처리 ---
  canvas.addEventListener('mousedown', e=>{
    const rect=canvas.getBoundingClientRect();
    const x=(e.clientX-rect.left)*(canvas.width/rect.width);
    const y=(e.clientY-rect.top)*(canvas.height/rect.height);
    onWall(x,y);
  });
  canvas.addEventListener('touchstart', e=>{
    if(e.touches.length){
      const rect=canvas.getBoundingClientRect();
      const t=e.touches[0];
      const x=(t.clientX-rect.left)*(canvas.width/rect.width);
      const y=(t.clientY-rect.top)*(canvas.height/rect.height);
      onWall(x,y);
    }
  });
  function onWall(x,y){
    const marginX=canvas.width*0.3, marginY=canvas.height*0.3;
    let wx=x,wy=y,ok=false;
    if(x<=marginX){wx=0;ok=true;}
    else if(x>=canvas.width-marginX){wx=canvas.width;ok=true;}
    else if(y<=marginY){wy=0;ok=true;}
    else if(y>=canvas.height-marginY){wy=canvas.height;ok=true;}
    if(!ok) return;

    state.wirePoints.push({x:wx,y:wy});
    if(state.wirePoints.length>=2){
      const p1=state.wirePoints[0], p2=state.wirePoints[1];
      state.wireLine={p1,p2};
      state.wirePoints.length=0;
      console.log("와이어 생성:",state.wireLine);
    }
  }

  // --- 그리기 ---
  function drawWalls(){
    ctx.save(); ctx.strokeStyle='#555'; ctx.lineWidth=WALL_THICK;
    ctx.strokeRect(HALF_WALL,HALF_WALL,canvas.width-WALL_THICK,canvas.height-WALL_THICK);
    ctx.restore();
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#222'; ctx.fillRect(0,0,canvas.width,canvas.height);
    drawWalls();
    if(state.wireLine){
      ctx.strokeStyle='cyan'; ctx.lineWidth=4;
      ctx.beginPath();
      ctx.moveTo(state.wireLine.p1.x,state.wireLine.p1.y);
      ctx.lineTo(state.wireLine.p2.x,state.wireLine.p2.y);
      ctx.stroke();
    }
    drawPlayer(state.player.x,state.player.y);
    requestAnimationFrame(draw);
  }
  draw();
})();
</script>
</body>
</html>
